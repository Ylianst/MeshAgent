name: Build OpenSSL Linux

on:
  workflow_dispatch:
    inputs:
      openssl_version:
        description: 'OpenSSL version to build'
        required: false
        default: '3.5.4'
  push:
    branches:
      - master
    paths:
      - '.docker/openssl/**'
      - '.github/workflows/build-openssl-linux.yml'

jobs:
  build-linux:
    strategy:
      matrix:
        arch:
          # x86-64 build (glibc)
          - { name: 'x86-64', platform: 'linux/amd64', image: 'debian:bullseye', openssl: 'linux-x86_64', archname: 'x86-64' }

          # x86 build (glibc)
          - { name: 'x86', platform: 'linux/386', image: 'i386/debian:bullseye', openssl: 'linux-x86', archname: 'x86' }

          # ARM64 build (glibc)
          - { name: 'arm64', platform: 'linux/arm64', image: 'arm64v8/debian:bullseye', openssl: 'linux-aarch64', archname: 'arm64' }

          # ARMhf build (glibc)
          - { name: 'armhf', platform: 'linux/arm/v7', image: 'arm32v7/debian:bullseye', openssl: 'linux-armv4', archname: 'armhf' }
      fail-fast: false

    runs-on: ubuntu-latest

    name: Build ${{ matrix.arch.name }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all

      - name: Download OpenSSL source
        run: |
          VERSION="${{ github.event.inputs.openssl_version || '3.5.4' }}"
          BUILD_DIR="openssl-build-linux-${{ matrix.arch.name }}"
          curl -L "https://github.com/openssl/openssl/releases/download/openssl-$VERSION/openssl-$VERSION.tar.gz" -o openssl.tar.gz
          mkdir -p "$BUILD_DIR"
          tar -xzf openssl.tar.gz -C "$BUILD_DIR" --strip-components=1
          rm openssl.tar.gz

      - name: Build OpenSSL in Docker
        run: |
          docker run --rm --platform=${{ matrix.arch.platform }} \
            -v "$PWD/openssl-build-linux-${{ matrix.arch.name }}:/build" \
            -v "$PWD/openssl-output:/output" \
            -w /build \
            ${{ matrix.arch.image }} \
            bash -c "apt-get update -qq && \
                     apt-get install -y -qq build-essential perl > /dev/null 2>&1 && \
                     ./Configure ${{ matrix.arch.openssl }} \
                       no-weak-ssl-ciphers no-srp no-psk no-comp no-zlib no-zlib-dynamic \
                       no-threads no-dso no-shared no-asm no-rc5 no-idea \
                       no-md4 no-rmd160 no-ssl no-ssl3 no-seed no-camellia no-bf no-cast \
                       no-md2 no-mdc2 \
                       --release && \
                     make -j\$(nproc) build_libs && \
                     mkdir -p /output/${{ matrix.arch.archname }} && \
                     cp libssl.a libcrypto.a /output/${{ matrix.arch.archname }}/ && \
                     echo 'Build complete for ${{ matrix.arch.name }}'"

      - name: Verify build
        run: |
          ls -lh openssl-output/${{ matrix.arch.archname }}/
          file openssl-output/${{ matrix.arch.archname }}/*.a || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openssl-linux-${{ matrix.arch.name }}
          path: openssl-output/${{ matrix.arch.archname }}/*.a
          retention-days: 30

  combine-artifacts:
    needs: build-linux
    runs-on: ubuntu-latest
    name: Combine all Linux builds

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Combine into single structure
        run: |
          mkdir -p openssl-linux-libs/x86-64
          mkdir -p openssl-linux-libs/x86
          mkdir -p openssl-linux-libs/arm64
          mkdir -p openssl-linux-libs/armhf

          # Copy all libraries to their respective architecture folders
          cp artifacts/openssl-linux-x86-64/*.a openssl-linux-libs/x86-64/ || true
          cp artifacts/openssl-linux-x86/*.a openssl-linux-libs/x86/ || true
          cp artifacts/openssl-linux-arm64/*.a openssl-linux-libs/arm64/ || true
          cp artifacts/openssl-linux-armhf/*.a openssl-linux-libs/armhf/ || true

          # Display results
          echo "=== Build Results ==="
          find openssl-linux-libs -type f -exec ls -lh {} \;

      - name: Upload combined artifact
        uses: actions/upload-artifact@v4
        with:
          name: openssl-3.5.4-linux-all
          path: openssl-linux-libs/
          retention-days: 90

      - name: Create build report
        run: |
          cat > BUILD_REPORT.md << 'EOF'
          # OpenSSL 3.5.4 Linux Build Report

          ## Build Date
          $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          ## Architectures Built
          - **x86-64** (64-bit Intel/AMD with glibc)
          - **x86** (32-bit Intel/AMD with glibc)
          - **ARM64** (64-bit ARM with glibc)
          - **ARMhf** (32-bit ARM hard-float with glibc)

          ## Libraries Created

          ### x86-64
          $(ls -lh openssl-linux-libs/x86-64/*.a 2>/dev/null || echo "No files")

          ### x86
          $(ls -lh openssl-linux-libs/x86/*.a 2>/dev/null || echo "No files")

          ### ARM64
          $(ls -lh openssl-linux-libs/arm64/*.a 2>/dev/null || echo "No files")

          ### ARMhf
          $(ls -lh openssl-linux-libs/armhf/*.a 2>/dev/null || echo "No files")

          ## Build Configuration
          All builds use identical OpenSSL configure options:
          ```
          no-weak-ssl-ciphers no-srp no-psk no-comp no-zlib no-zlib-dynamic
          no-threads no-dso no-shared no-asm no-rc5 no-idea
          no-md4 no-rmd160 no-ssl no-ssl3 no-seed no-camellia no-bf no-cast
          no-md2 no-mdc2
          ```

          ## Compiler
          - GCC from Debian Bullseye
          - Standard glibc linking

          ## Build Method
          - Docker with QEMU for cross-platform builds
          - Platform-specific base images for each architecture

          ## GitHub Actions Workflow
          Built using: `.github/workflows/build-openssl-linux.yml`

          EOF

      - name: Upload build report
        uses: actions/upload-artifact@v4
        with:
          name: build-report
          path: BUILD_REPORT.md
          retention-days: 90
